"use client";

import { useMemo } from "react";
import {
  SUBREDDIT_COLORS,
  USERS_BY_SUBREDDIT,
} from "@/app/lib/resultsVisualData";
import { createZipBlob } from "@/app/lib/simpleZip";
import styles from "@/app/redditdemand.module.css";

type SubredditUsersScreenProps = {
  query: string;
};

function formatPercent(value: number) {
  return `${value.toFixed(1)}%`;
}

export default function SubredditUsersScreen({ query }: SubredditUsersScreenProps) {
  const subredditEntries = useMemo(() => {
    const entries = Object.entries(USERS_BY_SUBREDDIT);
    const total = entries.reduce((sum, [, users]) => sum + users.length, 0);

    return entries.map(([subreddit, users], index) => ({
      subreddit,
      users,
      count: users.length,
      color: SUBREDDIT_COLORS[index % SUBREDDIT_COLORS.length],
      percentage: (users.length / total) * 100,
    }));
  }, []);

  const pieBackground = useMemo(() => {
    let current = 0;
    const slices = subredditEntries.map((entry) => {
      const start = current;
      current += entry.percentage;
      return `${entry.color} ${start}% ${current}%`;
    });
    return `conic-gradient(${slices.join(", ")})`;
  }, [subredditEntries]);

  function downloadUsersZip() {
    const rows = ["username,subreddit"];
    subredditEntries.forEach((entry) => {
      entry.users.forEach((user) => rows.push(`${user},${entry.subreddit}`));
    });

    const usersCsv = rows.join("\n");
    const notes = [
      "Mock export generated by RedditDemand frontend preview.",
      `Topic: ${query}`,
      `Profiles exported: ${rows.length - 1}`,
    ].join("\n");

    const zipBlob = createZipBlob([
      { name: "reddit_profiles.csv", content: usersCsv },
      { name: "README.txt", content: notes },
    ]);

    const url = URL.createObjectURL(zipBlob);
    const anchor = document.createElement("a");
    anchor.href = url;
    anchor.download = "redditdemand-users.zip";
    anchor.click();
    URL.revokeObjectURL(url);
  }

  return (
    <section className={styles.visualCard}>
      <div className={styles.visualHeader}>
        <h2 className={styles.visualTitle}>User Distribution by Subreddit</h2>
        <p className={styles.visualSub}>
          Profiles discussing <strong>{query}</strong>, grouped by subreddit and share.
        </p>
      </div>

      <div className={styles.pieGrid}>
        <div className={styles.piePanel}>
          <div className={styles.pieChart} style={{ background: pieBackground }} aria-hidden />
          <div className={styles.legendList}>
            {subredditEntries.map((entry) => (
              <div key={entry.subreddit} className={styles.legendItem}>
                <span className={styles.legendSwatch} style={{ background: entry.color }} />
                <span className={styles.legendLabel}>{entry.subreddit}</span>
                <span className={styles.legendValue}>
                  {entry.count} users ({formatPercent(entry.percentage)})
                </span>
              </div>
            ))}
          </div>

          <button type="button" className={styles.primaryButton} onClick={downloadUsersZip}>
            Download User List (.zip)
          </button>
        </div>

        <div className={styles.usersPanel}>
          {subredditEntries.map((entry) => (
            <article key={entry.subreddit} className={styles.userGroup}>
              <h3 className={styles.userGroupTitle}>{entry.subreddit}</h3>
              <div className={styles.userChips}>
                {entry.users.map((user) => (
                  <span key={`${entry.subreddit}-${user}`} className={styles.userChip}>
                    {user}
                  </span>
                ))}
              </div>
            </article>
          ))}
        </div>
      </div>
    </section>
  );
}
